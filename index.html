<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>2JCIE-BU01</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
</head>
<body>
  <div class="container">
    <div class="row mt-3">
      <div class="col-12">
        <h1>OMRON 2JCIE-BU01</h1>
      </div>
    </div>
    <div class="row">
      <div id="txtMessage" class="col-12"></div>
    </div>

    <div id="divConnect" class="row mt-5">
      <div class="col-12 text-center">
        <button id="cmdConnect" class="btn btn-primary">Connect to<br>2JCIE-BU01</button>
      </div>
    </div>

    <div id="divTabs" class="d-none">
      <div class="row">
        <div class="col-12">
          <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tabHome" data-bs-toggle="tab" data-bs-target="#home-tab-pane" type="button" role="tab">Sensor</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tabControl" data-bs-toggle="tab" data-bs-target="#control-tab-pane" type="button" role="tab">Control</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tabInfo" data-bs-toggle="tab" data-bs-target="#info-tab-pane" type="button" role="tab">Info</button>
            </li>
          </ul>
          <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active mt-3 mx-2" id="home-tab-pane" role="tabpanel"tabindex="0">
              <div class="row">
                <div class="col-6 text-end" style="position:relative">
                  <span id="txtTemp" class="display-1 pe-3">---</span>
                  <div style="position:absolute;top:0">温度</div>
                  <div style="position:absolute;bottom:0;right:12px">&deg;C</div>
                </div>
                <div class="col-6 text-end" style="position:relative">
                  <span id="txtHm" class="display-1 pe-4">---</span>
                  <div style="position:absolute;top:0">湿度</div>
                  <div style="position:absolute;bottom:0;right:20px">%</div>
                </div>
              </div>
              <div class="row mt-3 justify-content-md-center">
                <div class="col-12 text-end" style="position:relative">
                  <span id="txtAtm" class="display-1 pe-4">---</span>
                  <div style="position:absolute;top:0">気圧</div>
                  <div style="position:absolute;bottom:0;right:4px">hPa</div>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-6 text-end" style="position:relative">
                  <span id="txtLight" class="display-1 pe-3">---</span>
                  <div style="position:absolute;top:0">照度</div>
                  <div style="position:absolute;bottom:0;right:12px">lx</div>
                </div>
                <div class="col-6 text-end" style="position:relative">
                  <span id="txtNoise" class="display-1 pe-4">---</span>
                  <div style="position:absolute;top:0">騒音</div>
                  <div style="position:absolute;bottom:0;right:12px">dB</div>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-6 text-end" style="position:relative">
                  <span id="txtTVOC" class="display-1 pe-3">---</span>
                  <div style="position:absolute;top:0">eTVOC</div>
                  <div style="position:absolute;bottom:0;right:0">ppb</div>
                </div>
                <div class="col-6 text-end" style="position:relative">
                  <span id="txtCO2" class="display-1 pe-4">---</span>
                  <div style="position:absolute;top:0">eCO<sub>2</sub></div>
                  <div style="position:absolute;bottom:0;right:0">ppm</div>
                </div>
              </div>
              <hr>
              <div class="row mt-3">
                <div class="col-6 text-end pt-4" style="position:relative">
                  <span id="txtTHI" class="display-1 pe-3">---</span>
                  <div class="text-start" style="position:absolute;top:0">不快指数 <span class="text-secondary">(THI)</span></div>
                  <div style="position:absolute;bottom:0;right:0"></div>
                </div>
                <div class="col-6 text-end pt-4" style="position:relative">
                  <span id="txtWBGT" class="display-1 pe-4">---</span>
                  <div class="text-start" style="position:absolute;top:0">暑さ指数 <span class="text-secondary">(WBGT)</span></div>
                  <div style="position:absolute;bottom:0;right:20px">&deg;C</div>
                </div>
              </div>
            </div>
            <div class="tab-pane fade mt-3 mx-2" id="control-tab-pane" role="tabpanel" tabindex="0">
              <div class="row">
                <div class="col-9">
                  <h4>LED setting [normal state]</h4>
                </div>
                <div class="col-3 text-end">
                  <button id="cmdLedNorm" class="btn btn-sm btn-link">反映</button>
                </div>
                <div class="col-12">
                  <label for="selRule" class="form-label">Display rule</label>
                  <select class="form-select" id="selRule">
                    <option value="0">Normally OFF</option>
                    <option value="1">Normally ON</option>
                    <option value="2">Temperature value scales</option>
                    <option value="3">Relative humidity value scales</option>
                    <option value="4">Ambient light value scales</option>
                    <option value="5">Barometric pressure value scales</option>
                    <option value="6">Sound noise value scales</option>
                    <option value="7">eTVOC value scales</option>
                    <option value="8">SI value scales</option>
                    <option value="9">PGA value scale</option>
                  </select>
                </div>
                <div class="col-12 mt-3">
                  Intensity of LEDs (0 - 255)
                </div>
                <div class="col-4 mt-1">
                  <label for="txtRed" class="form-label">Red</label>
                  <input class="form-control" id="txtRed" value="0">
                </div>
                <div class="col-4 mt-1">
                  <label for="txtGreen" class="form-label">Green</label>
                  <input class="form-control" id="txtGreen" value="0">
                </div>
                <div class="col-4 mt-1">
                  <label for="txtBlue" class="form-label">Blue</label>
                  <input class="form-control" id="txtBlue" value="0">
                </div>
              </div>

              <hr>

              <div class="row">
                <div class="col-9">
                  <h4>LED setting [operation]</h4>
                </div>
                <div class="col-3 text-end">
                  <button id="cmdLedOp" class="btn btn-sm btn-link">反映</button>
                </div>
                <form id="frmLedOperation" class="col-12">
                  <div class="row">
                    <div class="col-3">
                      <label class="form-label">Start up</label>
                    </div>
                    <div class="col-9">
                      <div class="row">
                        <div class="col-5">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="radStartUp" id="radStartUp0" value="0">
                            <label class="form-check-label fw-bold" for="radStartUp0">Rainbow</label>
                          </div>
                        </div>
                        <div class="col-7">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="radStartUp" id="radStartUp1" value="1">
                            <label class="form-check-label" for="radStartUp0">BLUE</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-3">
                      <label class="form-label">Error</label>
                    </div>
                    <div class="col-9">
                      <div class="row">
                        <div class="col-5">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="radError" id="radError0" value="0">
                            <label class="form-check-label fw-bold" for="radError0">NONE</label>
                          </div>
                        </div>
                        <div class="col-7">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="radError" id="radError1" value="1">
                            <label class="form-check-label" for="radError1">RED</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-3">
                      <label class="form-label">Connection</label>
                    </div>
                    <div class="col-9">
                      <div class="row">
                        <div class="col-5">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="radConn" id="radConn0" value="0">
                            <label class="form-check-label fw-bold" for="radConn0">NONE</label>
                          </div>
                        </div>
                        <div class="col-7">
                          <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="radConn" id="radConn1" value="1">
                            <label class="form-check-label" for="radConn1">GREEN on 1sec</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </form>
              </div>

              <hr>

              <div class="row">
                <div class="col-9">
                  <h4>Advertise setting</h4>
                </div>
                <div class="col-3 text-end">
                  <button id="cmdAdSetting" class="btn btn-sm btn-link">反映</button>
                </div>
                <div class="col-12">
                  <label class="form-label">Advertising interval</label>
                  <div class="row">
                    <div class="col-4">
                      <input class="form-control" id="txtAdInterval" value="0">
                      = <span id="spanAdInterval" class="fw-bold"></span>s
                    </div>
                    <div class="col-8">
                      <p class="fs-6 lh-1">
                      Range: 160 to 16384 (100ms to 10.24s)<br>
                      Unit: 0.625ms<br>
                      Default: 160 (100ms)
                      </p>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <label for="selAdMode" class="form-label">Advertising mode</label>
                  <select class="form-select" id="selAdMode">
                    <option value="1">Sensor data (default)</option>
                    <option value="2">Calculation data</option>
                    <option value="3">Sensor data & Calculation data w/Scan Resp</option>
                    <option value="4">Sensor flag & Calculation flag w/Scan Resp</option>
                    <option value="5">Serial number</option>
                  </select>
                </div>
              </div>

            </div>
            <div class="tab-pane fade mt-3 mx-2" id="info-tab-pane" role="tabpanel" tabindex="0">
              <div class="row">
                <div class="col-12">
                  <h3>デバイス情報</h3>
                </div>
                <div class="col-12 text-end mt-2" style="position:relative">
                  <span id="txtModelNo" class="display-1">---</span>
                  <div style="position:absolute;top:0">Model No.</div>
                </div>
                <div class="col-12 text-end mt-2" style="position:relative">
                  <span id="txtSerialNo" class="display-1 text-secondary">---</span>
                  <div class="text-start" style="position:absolute;top:0">Serial No.<br>(Blocklistにより取得できない)</div>
                </div>
                <div class="col-12 text-end mt-2" style="position:relative">
                  <span id="txtFirmwareRev" class="display-1">---</span>
                  <div style="position:absolute;top:0">Firmware Rev.</div>
                </div>
                <div class="col-12 text-end mt-2" style="position:relative">
                  <span id="txtHardwareRev" class="display-1">---</span>
                  <div style="position:absolute;top:0">Hardware Rev.</div>
                </div>
                <div class="col-12 text-end mt-2" style="position:relative">
                  <span id="txtManufacturer" class="display-1">---</span>
                  <div style="position:absolute;top:0">Manufacturer</div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>  <!-- /row -->

      <hr>

      <div id="divDisconnect" class="row">
        <div class="col-12 text-center">
          <button id="cmdDisconnect" class="btn btn-primary">Disconnect</button>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
  <script src="./2jcie-bu01.js"></script>
  <script>
  (() => {
    function showSensorData(sensor) {
      document.querySelector("#txtTemp").textContent = sensor.temperature;
      document.querySelector("#txtHm").textContent = sensor.humidity;
      document.querySelector("#txtAtm").textContent = sensor.pressure;
      document.querySelector("#txtLight").textContent = sensor.light;
      document.querySelector("#txtNoise").textContent = sensor.noise;
      document.querySelector("#txtTVOC").textContent = sensor.eTVOC;
      document.querySelector("#txtCO2").textContent = sensor.eCO2;
    }

    function showCalcResults(calc) {
      document.querySelector("#txtTHI").textContent = calc.thi;
      document.querySelector("#txtWBGT").textContent = calc.wbgt;
    }

    function updateIntensity(el) {
      const formValue = el.value;
      let value = parseInt(formValue);
      if(isNaN(value) || value < 0){ value = 0; }
      else if(value > 255){ value = 255; }
      el.value = value;
    }

    function updateAdInterval() {
      const formValue = document.querySelector("#txtAdInterval").value;
      let value = parseInt(formValue);
      if(isNaN(value) || value < 160){ value = 160; }
      else if(value > 16384){ value = 16384; }
      document.querySelector("#txtAdInterval").value = value;
      document.querySelector("#spanAdInterval").textContent = 0.625 * value / 1000;
    }

    const myDev = new MyDevice();

    document.addEventListener("MyDeviceStatusChanged", evt => {
      function setMessage(html) {
        document.querySelector("#txtMessage").innerHTML = html;
      }
      const detail = evt.detail;
      switch(evt.detail.type) {
        case MSG_CONNECTING_DEVICE: setMessage("デバイスに接続中…"); break;
        case MSG_CONNECTING_GATT: setMessage("GATTサーバーに接続中…"); break;
        case MSG_CONNECTED: setMessage("GATTサーバーに接続しました");
        case MSG_CONNECT_FAILED: setMessage(`接続に失敗しました<br>${detail.info.message}`); break;
        case MSG_DISCONNECTED: setMessage("GATTサーバーから切断しました"); break;
        case MSG_NOTIFY_STARTING: setMessage("サービスのNotifyに接続中…"); break;
        case MSG_NOTIFY_SET_EVENTS: setMessage(`${detail.info.ch}: Notifyイベントを設定中…`); break;
        case MSG_NOTIFY_STARTED: setMessage("サービスへの接続を完了しました"); break;
        case MSG_WRITE_BYTES: setMessage(`設定を書き込みます…<br>${detail.info.ch}: ${detail.info.data}`); break;
        case MSG_WRITE_SUCCESS: setMessage(`設定を書き込みました<br>${detail.info.ch}: ${detail.info.data}`); break;
      }
    });

    document.querySelector("#cmdConnect").addEventListener("click", async evt => {
      // 接続する
      evt.target.disabled = true;
      try {
        await myDev.connect();
        await myDev.listenNotifications(showSensorData, showCalcResults);
        document.querySelector("#divConnect").classList.add("d-none");
        document.querySelector("#divTabs").classList.remove("d-none");
      } finally {
        evt.target.disabled = false;
      }
    });

    document.querySelector("#cmdDisconnect").addEventListener("click", async evt => {
      // 接続終了
      evt.target.disabled = true;
      try { myDev.disconnect(); }
      finally { evt.target.disabled = false; }
      document.querySelector("#divConnect").classList.remove("d-none");
      document.querySelector("#divTabs").classList.add("d-none");
    });

    document.querySelector("#txtRed").addEventListener("change", evt => updateIntensity(evt.target));
    document.querySelector("#txtGreen").addEventListener("change", evt => updateIntensity(evt.target));
    document.querySelector("#txtBlue").addEventListener("change", evt => updateIntensity(evt.target));

    document.querySelector("#txtAdInterval").addEventListener("change", evt => updateAdInterval());

    document.querySelector("#myTab").addEventListener("show.bs.tab", async evt => {
      // タブを開いたときのイベント
      if(evt.target.id == "tabControl"){
        // 設定を得る
        const ledNorm = await myDev.getLEDSettingNormal();
        const ledOp = await myDev.getLEDSettingOperation();
        const adSetting = await myDev.getAdvertiseSetting();

        document.querySelector("#selRule").value = ledNorm.displayRule;
        document.querySelector("#txtRed").value = ledNorm.red;
        document.querySelector("#txtGreen").value = ledNorm.green;
        document.querySelector("#txtBlue").value = ledNorm.blue;

        const frmOp = document.querySelector("#frmLedOperation");
        frmOp.radStartUp.value = ledOp.startUp;
        frmOp.radError.value = ledOp.error;
        frmOp.radConn.value = ledOp.connection;

        document.querySelector("#txtAdInterval").value = adSetting.adInterval;
        document.querySelector("#selAdMode").value = adSetting.adMode;
        updateAdInterval();
      }else if(evt.target.id == "tabInfo"){
        // Device Informationを得る
        const devInfo = await myDev.getDeviceInformation();
        document.querySelector("#txtModelNo").textContent = devInfo.modelNo;
        document.querySelector("#txtSerialNo").textContent = devInfo.serialNo;
        document.querySelector("#txtFirmwareRev").textContent = devInfo.firmwareRev;
        document.querySelector("#txtHardwareRev").textContent = devInfo.hardwareRev;
        document.querySelector("#txtManufacturer").textContent = devInfo.manufacturer;
      }
    });

    document.querySelector("#cmdLedNorm").addEventListener("click", async evt => {
      updateIntensity(document.querySelector("#txtRed"));
      updateIntensity(document.querySelector("#txtGreen"));
      updateIntensity(document.querySelector("#txtBlue"));
      const cfg = {
        displayRule: parseInt(document.querySelector("#selRule").value),
        red: parseInt(document.querySelector("#txtRed").value),
        green: parseInt(document.querySelector("#txtGreen").value),
        blue: parseInt(document.querySelector("#txtBlue").value)
      };
      await myDev.setLEDSettingNormal(cfg);
    });

    document.querySelector("#cmdLedOp").addEventListener("click", async evt => {
      const frmOp = document.querySelector("#frmLedOperation");
      const cfg = {
        startUp: parseInt(frmOp.radStartUp.value),
        error: parseInt(frmOp.radError.value),
        connection: parseInt(frmOp.radConn.value)
      };
      await myDev.setLEDSettingOperation(cfg);
    });

    document.querySelector("#cmdAdSetting").addEventListener("click", async evt => {
      updateAdInterval();
      const cfg = {
        adInterval: parseInt(document.querySelector("#txtAdInterval").value),
        adMode: parseInt(document.querySelector("#selAdMode").value)
      };
      await myDev.setAdvertiseSetting(cfg);
    });
  })();
  </script>
</body>
</html>
